\documentclass[openany, twoside, 12pt]{utbook}
%%%%%%%%%%%%%%%%%
%% Page layout %%
%%%%%%%%%%%%%%%%%
\usepackage{lltjp-geometry}
\usepackage[paperheight=222mm, % paper size including bleeding
            paperwidth=143mm,
            layout=a5paper, 
            layoutvoffset=3mm, % bleeding
            bindingoffset=-3mm % bleeding
            ]{geometry} 
% \usepackage{showframe}

%
% Adjust the layout to compensate for the diff between paperwidth and 
% a5paper (421.10078pt). Note: the total length added to \evensidemargin, 
% \oddsidemargin, and \textheight should equal to \paperwidth-421.10078pt.
% 
% \addtolength{\evensidemargin}{0.1\dimexpr(-421.10078pt+\paperwidth)\relax} 
% \addtolength{\oddsidemargin}{\dimexpr(-421.10078pt+\paperwidth)\relax}
\addtolength{\textheight}{\dimexpr(-421.10078pt+\paperwidth)\relax} 

% pushing the text body outward from the spine
\addtolength{\oddsidemargin}{-20pt} 
\addtolength{\evensidemargin}{20pt}
\addtolength{\topmargin}{30pt} % pushing the text body downward

%% width from the spine:
% \newlength{\oddsidewidthfromspine}
% \setlength{\oddsidewidthfromspine}{\dimexpr(\paperwidth-\textheight-1in-\oddsidemargin-3mm)\relax}
% \newlength{\evensidewidthfromspine}
% \setlength{\evensidewidthfromspine}{\dimexpr(1in+\evensidemargin-3mm)\relax}
% \showthe\oddsidewidthfromspine
% \showthe\evensidewidthfromspine
% \showthe\dimexpr(1in+\oddsidemargin-3mm)\relax 

\usepackage{setspace}

%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Latin alphabet layout %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%
\usepackage{tgpagella}
\usepackage[T1]{fontenc}

%%%%%%%%%%%%%%%%%%%
%% CTeX headings %%
%%%%%%%%%%%%%%%%%%%
\usepackage[fontset=custom, heading=true]{ctex}
\usepackage{zhnumber}
\ctexset{
  chapter = {
    name        = {古文觀止卷} ,
    number      = \zhnum{chapter} ,
    % numbering   = false,
    format      = \huge\bfseries ,
    nameformat  = {} ,
    titleformat = {} ,
    aftername   = \quad ,
    beforeskip  = 0 pt ,
    afterskip   = 20 pt ,
    afterindent = true ,
    pagestyle   = main ,
  } ,
  section = {
    numbering   = false ,
    format      = \Large\bfseries,
    indent      = 42 pt ,
    afterindent = true ,
  }
}

%% draft watermark
% \usepackage[colorspec=0.9]{draftwatermark}
% \SetWatermarkText{未 經 審 定}
% \SetWatermarkScale{0.5}
\usepackage{graphicx}

%%%%%%%%%
%% ToC %%
%%%%%%%%%
\usepackage[titles]{tocloft}
\usepackage{everypage}
\usepackage{calc}
\makeatletter
\AddEverypageHook{\if@mainmatter\addtocontents{toc}{
  \protect\cftsetpnumwidth{\widthof{\thepage} * \real{0.5}}
  }
\fi}
\makeatother
\renewcommand{\cftchapfont}{\bfseries}
\renewcommand{\cftchappagefont}{\small}
\renewcommand{\cftsecpagefont}{\small}

%% ToC: scale page no.
\usepackage{xstring}
\newcommand{\scalepagenum}[1]{\StrLeft{\detokenize{#1}}{1}[\firsttoken]\ifcat 一\firsttoken\scalebox{0.5}[1]{#1}\else #1\fi}
\makeatletter
\renewcommand{\cftchapfillnum}[1]{%
    {\cftchapleader}\nobreak
    \pbox<t>[\@pnumwidth][\cftpnumalign]{{\cftchappagefont\scalepagenum{#1}}}\cftchapafterpnum\par
  }
\renewcommand{\cftsecfillnum}[1]{%
    {\cftsecleader}\nobreak
    \pbox<t>[\@pnumwidth][\cftpnumalign]{{\cftchappagefont\scalepagenum{#1}}}\cftsecafterpnum\par
}
\makeatother
\renewcommand{\contentsname}{古文觀止目錄}

%%%%%%%%%%%%%%%%
%% page style %%
%%%%%%%%%%%%%%%%
\zhnumsetup{style=Traditional}
\usepackage{titleps}
\newcommand\frontchaptertitle{}
\makeatletter
  \def\mainchapterheader{
    \if@mainmatter
      \raisebox{\dimexpr-\height-\headsep\relax}[0pt]{%
        \hbox to \textheight{%
          \tate\hspace{3zh}\small
          \ifnum\value{chapter} > \z@
            \CTEXthechapter\quad\chaptertitle
          \else
            \frontchaptertitle
          \fi\hfill
          \scalebox{0.5}[1]{\thepage}\hspace{4zh}}}%
    \else
      \raisebox{\dimexpr-\height-\headsep\relax}[0pt]{%
        \hbox to \textheight{%
          \tate\hspace{3zh}\small\chaptertitle\hfill
          \thepage\hspace{4zh}}}%
    \fi
  }
  \newpagestyle{main}{%
    \widenhead{24pt}{24pt}%
    \sethead[][][{\mainchapterheader}]{\mainchapterheader}{}{}
  }
\makeatother
\pagestyle{main}

\addtolength{\textwidth}{\footskip}

%% underlines
\usepackage[normalem]{ulem}
\newcommand\ProperName[1]{\hskip.1zw\uline{\kern-.1zw#1\kern-.1zw}\kern.1zw}
% \newcommand\PlaceName[1]{\def\tempdepth{\the\ULdepth}\setlength{\ULdepth}{.75zw}\hskip.1zw\uuline{\kern-.1zw#1\kern-.1zw}\kern.1zw\setlength{\ULdepth}{\tempdepth}}
\newcommand\smallwave{\bgroup \markoverwith{\lower0.9zh\hbox{$\tilde{\null\kern0.25zw}$}}\ULon}
\newcommand\BookTitle[1]{\hskip.15zw\smallwave{\kern-.1zw#1\kern-.1zw}\kern.1zw}

%%%%%%%%%%%%%%%%%%%%%%%%
%% critical apparatus %%
%%%%%%%%%%%%%%%%%%%%%%%%

\usepackage{endnotes}
\newlength{\moziretuhaba}
\newlength{\moziretutakasa}
\newlength{\mozireturaise}
\newlength{\moziretuskip}
\def\makenotenumbermark#1{\settowidth{\moziretuhaba}{{\scriptsize #1}}%
        \addtolength{\moziretuhaba}{2pt}%
        \settoheight{\moziretutakasa}{{\scriptsize #1}}%
        \setlength{\mozireturaise}{\dimexpr(0.2zw+\moziretutakasa)\relax}%
        \setlength{\moziretuskip}{\dimexpr(1pt)\relax}%
		\unskip%
		\hskip\kanjiskip%
		\parbox[b]{\moziretuhaba}{\hskip\moziretuskip\raisebox{\mozireturaise}{\scriptsize #1}}
		\unskip%
		}
\renewcommand{\makeenmark}{\makenotenumbermark{\scalebox{0.5}[1]{{［\normalfont\zhdigits{\theenmark}］}}}}
\renewcommand{\enotesize}{\small}
\renewcommand\enoteheading{
  \vskip1.5zh % \hrule width 0.3\textwidth height 0.5pt\vskip1em
  % \fbox{\textbf{校勘記}}
  % \vskip1em\nopagebreak[4]
}
\makeatletter
\def\enoteformat{%
  \scalebox{0.5}[1]{{［\normalfont\zhdigits{\theenmark}］}}\enskip
}
\makeatother

%%%%%%%%%%%%%%%%
%% sectioning %%
%%%%%%%%%%%%%%%%
\usepackage{etoolbox}
\pretocmd{\chapter}{\setcounter{endnote}{0}}{}{}
\pretocmd{\section}{\setcounter{endnote}{0}}{}{}
\makeatletter
\@addtoreset{endnote}{chapter}  
\@addtoreset{endnote}{section}
\makeatother

%%%%%%%%%%%%%%%%%%%%%%%
%% clear double page %%
%%%%%%%%%%%%%%%%%%%%%%%
\makeatletter
\def\emptycleardoublepage{\clearpage\ifodd\c@page\else
\thispagestyle{empty}%
\hbox{}\newpage\fi}
\makeatother

%%%%%%%%%%
%% misc %%
%%%%%%%%%%
\setlength\parindent{2zw}
\usepackage{multicol}
\usepackage{relsize}
\usepackage{datetime}
\usepackage{longtable}
\usepackage{bxtexlogo}
\usepackage[dvipdfmx, bookmarksnumbered]{hyperref}

%%%%%%%%%%
%% logo %%
%%%%%%%%%%
\newcommand{\dubaillogo}{{\centering {Dubail Editions $\cdot$ \setbox0=\hbox{Xg}\raisebox{\dimexpr-\dp0}{\includegraphics[height=1zh]{asset/colophon.eps}}~\par}}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{document}
%% empty page for LS barcode, between cover and interior
\thispagestyle{empty}%
\hbox{}\newpage
\thispagestyle{empty}%
\hbox{}\newpage

% extra empty page
\thispagestyle{empty}%
\hbox{}\newpage
\thispagestyle{empty}%
\hbox{}\newpage

%% Cover
\pagenumbering{gobble}
\thispagestyle{empty}
{\smash{\begin{minipage}<t>{\textwidth}
  \vspace{1in}
  \hspace{30pt}\makebox[10zh][s]{\tate\small\pbox<p>{〔清〕} 吳楚材 吳調侯 編}\\
  \hspace{30pt}\makebox[10zh][s]{\tate\small 裏瓣編輯部 校}
\end{minipage}}
\vfill
%{\it{\Large\parbox{1zw}{校栞}}\quad\Huge 古 文 觀 止} %\quad{\normalsize 徵 求 意 見 稿}
\hspace{0zh}\parbox<y>{1in}{\centering\includegraphics[width=1.8cm]{asset/title.eps}}
\hfill\parbox<y>{0.9\textheight}{\centering\includegraphics[width=1cm]{asset/hsu.eps}\par
\vskip5pt
\dubaillogo
MMXXV \par
\vspace{30pt}}
\par% 
\vfill}
\newpage\thispagestyle{empty}
\hfill
{
\begin{minipage}<y>[htpb]{\textheight}
  \dubaillogo
  \vspace{0.5cm}
  {\parskip=5pt \scriptsize\centering
  Dubail Editions is an imprint of DNB Publishing LLC.\par
  \vspace{0.5cm}
  First published by Dubail Editions 2024\\
  Revised Edition 2025\par
  Copyright \textcopyright\ Dubail Editions 2025 \\
  All rights reserved.\par
  
  \textsc{ISBN}: 979-8-9905384-1-2\par
  Typeset using \upLaTeX.\\
  Text set in KingHwa Old Song 京華老宋体 (v2.0).\\
  Title set in aoyagireisyosimo {\fontfamily{jpmc}\selectfont 青柳隷書しも} (v2.01).\par
  Please report any errors to \url{editor@dubaileditions.com}

  \vspace{2cm}
  {\bfseries\large 校栞古文觀止}\par
  〔清〕 吳楚材 吳調侯 編\par
  裏瓣編輯部 校\par
  \textasteriskcentered\par
  {\normalsize 裏 瓣 書 局 出 版 發 行\par}
  {如有失校之處，敬希指正：\url{editor@dubaileditions.com}\par}
  %% build info
  % The source and scripts used to compose this document are available at \url{https://github.com/mondain-dev/gwgz}.\par
  % This version was compiled on \today.\par
  \vspace{0.5in}
  }
\end{minipage}
}
%% ToC
\frontmatter
\setstretch{1.15}

% \renewcommand\thepage{\rensuji{\arabic{page}}\relax}
\phantomsection
\renewcommand\thepage{\rensuji{\roman{page}}\relax}
\begin{multicols}{2}
\addcontentsline{toc}{chapter}{目錄}
\tableofcontents
\end{multicols}

\chapter{凡例}
\input{tex/note.tex}
\mainmatter
\renewcommand\thepage{\zhdigits{\arabic{page}}\relax}
\chapter[{\small 周文}]{周文}
\input{tex/book_1.tex}

\chapter[{\small 周文}]{周文}
\input{tex/book_2.tex}

\chapter[{\small 周文}]{周文}
\input{tex/book_3.tex}

\chapter[{\small 秦文 楚辭}]{秦文 楚辭}
\input{tex/book_4.tex}

\chapter[{\small 漢文}]{漢文}
\input{tex/book_5.tex}

\chapter[{\small 漢文}]{漢文}
\input{tex/book_6.tex}

\chapter[{\small 六朝 唐文}]{六朝 唐文}
\input{tex/book_7.tex}

\chapter[{\small 唐文}]{唐文}
\input{tex/book_8.tex}

\chapter[{\small 唐宋文}]{唐宋文}
\input{tex/book_9.tex}

\chapter[{\small 宋文}]{宋文}
\input{tex/book_10.tex}

\chapter[{\small 宋文}]{宋文}
\input{tex/book_11.tex}

\chapter[{\small 明文}]{明文}
\input{tex/book_12.tex}

\emptycleardoublepage
%% end page between cover and interior
\thispagestyle{empty}%
\hbox{}\newpage
\thispagestyle{empty}%
\hbox{}\newpage
\end{document}
